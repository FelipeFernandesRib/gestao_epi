{% extends 'basefinal.html' %}
{% load static %}

{% block content %}
<div class="content">
    <div class="form-box" style="width: 450px;">
        <h2>{% if emprestimo %}Editar Empr√©stimo{% else %}Novo Empr√©stimo{% endif %}</h2>

        <!-- Mensagens -->
        {% if messages %}
        <div class="messages-container">
            {% for message in messages %}
            <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
            {% endfor %}
        </div>
        {% endif %}

        <form method="post" id="emprestimoForm">
            {% csrf_token %}
            
            <!-- CAMPOS BLOQUEADOS NA EDI√á√ÉO -->
            {% if emprestimo %}
            <!-- CAMPOS HIDDEN PARA ENVIAR OS VALORES -->
            <input type="hidden" name="colaborador" value="{{ emprestimo.colaborador.id }}">
            <input type="hidden" name="epi" value="{{ emprestimo.epi.id }}">
            <input type="hidden" name="quantidade" value="{{ emprestimo.quantidade }}">
            {% if emprestimo.data_prevista_devolucao %}
            <input type="hidden" name="data_prevista_devolucao" value="{{ emprestimo.data_prevista_devolucao|date:'Y-m-d\TH:i' }}">
            {% endif %}

            <!-- CAMPOS VISUAIS (S√ì EXIBI√á√ÉO) -->
            <div class="mb-3">
                <label class="form-label">Colaborador *</label>
                <input type="text" class="form-control" value="{{ emprestimo.colaborador.nome }} ({{ emprestimo.colaborador.matricula }})" disabled>
                <div class="form-text text-muted">Campo bloqueado para edi√ß√£o</div>
            </div>

            <div class="mb-3">
                <label class="form-label">EPI *</label>
                <input type="text" class="form-control" value="{{ emprestimo.epi.nome }}" disabled>
                <div class="form-text text-muted">Campo bloqueado para edi√ß√£o</div>
            </div>

            <div class="mb-3">
                <label class="form-label">Quantidade *</label>
                <input type="number" class="form-control" value="{{ emprestimo.quantidade }}" disabled>
                <div class="form-text text-muted">Campo bloqueado para edi√ß√£o</div>
            </div>

            <div class="mb-3">
                <label class="form-label">Data do Empr√©stimo</label>
                <input type="text" class="form-control" value="{{ emprestimo.data_emprestimo|date:'d/m/Y H:i' }}" disabled>
                <div class="form-text text-muted">Campo bloqueado para edi√ß√£o</div>
            </div>

            <div class="mb-3">
                <label class="form-label">Data Prevista Devolu√ß√£o</label>
                <input type="text" class="form-control" 
                       value="{% if emprestimo.data_prevista_devolucao %}{{ emprestimo.data_prevista_devolucao|date:'d/m/Y H:i' }}{% else %}---{% endif %}" 
                       disabled>
                <div class="form-text text-muted">Campo bloqueado para edi√ß√£o</div>
            </div>
            {% else %}
            <!-- CAMPOS NORMAIS PARA NOVO EMPR√âSTIMO -->
            <div class="mb-3">
                <label for="id_colaborador" class="form-label">Colaborador *</label>
                <select name="colaborador" id="id_colaborador" class="form-select" required>
                    <option value="">Selecione um colaborador...</option>
                    {% for colaborador in colaboradores %}
                    <option value="{{ colaborador.id }}" 
                        {% if form.colaborador.value|add:0 == colaborador.id %}selected{% endif %}>
                        {{ colaborador.nome }} ({{ colaborador.matricula }})
                    </option>
                    {% endfor %}
                </select>
                {% if form.colaborador.errors %}
                <div class="text-danger">{{ form.colaborador.errors }}</div>
                {% endif %}
            </div>

            <div class="mb-3">
                <label for="id_epi" class="form-label">EPI *</label>
                <select name="epi" id="id_epi" class="form-select" required>
                    <option value="">Selecione um EPI...</option>
                    {% for epi in epis %}
                    <option value="{{ epi.id }}" 
                        {% if form.epi.value|add:0 == epi.id %}selected{% endif %}
                        data-estoque="{{ epi.quantidade_disponivel }}">
                        {{ epi.nome }}
                    </option>
                    {% endfor %}
                </select>
                <div id="estoque-info" class="form-text text-info">
                    üí° Selecione um EPI para ver o estoque dispon√≠vel
                </div>
                {% if form.epi.errors %}
                <div class="text-danger">{{ form.epi.errors }}</div>
                {% endif %}
            </div>

            <div class="mb-3">
                <label for="id_quantidade" class="form-label">Quantidade *</label>
                <input type="number" name="quantidade" id="id_quantidade" 
                       class="form-control" min="1" value="{{ form.quantidade.value|default:'1' }}" required>
                {% if form.quantidade.errors %}
                <div class="text-danger">{{ form.quantidade.errors }}</div>
                {% endif %}
            </div>

            <div class="mb-3">
                <label for="id_data_prevista_devolucao" class="form-label">Data Prevista Devolu√ß√£o</label>
                <input type="datetime-local" name="data_prevista_devolucao" id="id_data_prevista_devolucao" 
                       class="form-control" value="{{ form.data_prevista_devolucao.value|default:'' }}">
                <div class="form-text">Para empr√©stimos tempor√°rios</div>
                {% if form.data_prevista_devolucao.errors %}
                <div class="text-danger">{{ form.data_prevista_devolucao.errors }}</div>
                {% endif %}
            </div>
            {% endif %}

            <!-- CAMPOS EDIT√ÅVEIS (SEMPRE) -->
            <div class="mb-3">
                <label for="id_status" class="form-label">Status *</label>
                <select name="status" id="id_status" class="form-select" required>
                    {% for value, label in form.fields.status.choices %}
                        {% if not emprestimo %}
                            {% if value == "EMPRESTADO" or value == "FORNECIDO" %}
                            <option value="{{ value }}" 
                                {% if form.status.value == value %}selected{% endif %}>
                                {{ label }}
                            </option>
                            {% endif %}
                        {% else %}
                            <option value="{{ value }}" 
                                {% if form.status.value == value %}selected{% endif %}>
                                {{ label }}
                            </option>
                        {% endif %}
                    {% endfor %}
                </select>
                {% if form.status.errors %}
                <div class="text-danger">{{ form.status.errors }}</div>
                {% endif %}
            </div>

            <!-- OBSERVA√á√ÉO (apenas na edi√ß√£o para status espec√≠ficos) -->
            {% if emprestimo %}
            <div class="mb-3" id="observacao-container" style="display: none;">
                <label for="id_observacao_devolucao" class="form-label">Observa√ß√£o na Devolu√ß√£o</label>
                <textarea name="observacao_devolucao" id="id_observacao_devolucao" 
                          class="form-control" rows="3" 
                          placeholder="Descreva o estado do EPI...">{{ form.observacao_devolucao.value|default:'' }}</textarea>
                <div class="form-text">Obrigat√≥rio para status <strong>Danificado</strong> ou <strong>Perdido</strong></div>
                {% if form.observacao_devolucao.errors %}
                <div class="text-danger">{{ form.observacao_devolucao.errors }}</div>
                {% endif %}
            </div>
            {% endif %}

            <div class="form-actions">
                <button type="submit" class="btn-save">
                    {% if emprestimo %}Salvar Altera√ß√µes{% else %}Registrar Empr√©stimo{% endif %}
                </button>
                <a href="{% url 'lista_emprestimos' %}" class="btn-cancel">Cancelar</a>
            </div>
        </form>
    </div>
</div>

<script>
// Mostrar estoque dispon√≠vel quando selecionar EPI (apenas novo empr√©stimo)
{% if not emprestimo %}
function atualizarEstoque() {
    const epiSelect = document.getElementById('id_epi');
    const estoqueInfo = document.getElementById('estoque-info');
    const quantidadeInput = document.getElementById('id_quantidade');
    
    if (epiSelect.value) {
        const selectedOption = epiSelect.options[epiSelect.selectedIndex];
        const estoqueDisponivel = selectedOption.getAttribute('data-estoque');
        
        if (estoqueDisponivel) {
            const disponivel = parseInt(estoqueDisponivel);
            estoqueInfo.innerHTML = `<strong>üì¶ Estoque:</strong> ${disponivel} unidade(s) dispon√≠vel(s)`;
            quantidadeInput.max = disponivel;
        }
    } else {
        estoqueInfo.innerHTML = "üí° Selecione um EPI para ver o estoque dispon√≠vel";
    }
}

document.getElementById('id_epi').addEventListener('change', atualizarEstoque);
atualizarEstoque();
{% endif %}

// Mostrar/ocultar observa√ß√£o baseado no status (apenas na edi√ß√£o)
{% if emprestimo %}
function toggleObservacao() {
    const status = document.getElementById('id_status').value;
    const observacaoContainer = document.getElementById('observacao-container');
    
    if (observacaoContainer) {
        if (status === "DANIFICADO" || status === "PERDIDO") {
            observacaoContainer.style.display = 'block';
        } else {
            observacaoContainer.style.display = 'none';
        }
    }
}

document.getElementById('id_status').addEventListener('change', toggleObservacao);
toggleObservacao();
{% endif %}
</script>

{% endblock %}